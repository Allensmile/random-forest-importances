<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,400" />
<link rel="stylesheet" type="text/css" href="css/book.css"/>
<title>Beware Default Random Forest Importances</title>
</head>
<body>
<h1>Beware Default Random Forest Importances</h1>

<a href="http://parrt.cs.usfca.edu">Terence Parr</a>, Chris, Kerem, and <a href="http://www.fast.ai/about/#jeremy">Jeremy Howard</a>

<br><br>

<table border=0>
<tr>
	<td><img src="images/cls_dflt_random_annotated.png" width="85%"><br>
<b>Figure 1(a)</b>. <tt>scikit-learn</tt> default importances for Random Forest <b>classifier</b>  predicting apartment interest level (low, medium, high) using 5 features + a column of random numbers. Highly suspicious that random column is much more important than the number of bedrooms.
	<td>
<img src="images/regr_dflt_random_annotated.png" width="85%"><br>
<b>Figure 1(b)</b>. <tt>scikit-learn</tt> default importances for Random Forest <b>regressor</b> predicting apartment rental price from 4 features + a column of random numbers. Random column is last, as we would expect but the importance of the number of bathrooms for predicting price is highly suspicious.
</tr>
</table>

<table border=0>
<tr>
	<td width="50%"><img src="images/cls_dropcol_random.svg" width="85%"><br>
<b>Figure 2(a)</b>. Importances derived by dropping each column and retraining <tt>scikit-learn</tt> Random Forest <b>classifier</b>. Predicting apartment interest level (low, medium, high) using 5 features + a column of random numbers. The importance of the random column is at the bottom as it should be.
	<td width="50%"><img src="images/regr_dropcol_random.svg" width="85%"><br>
<b>Figure 2(b)</b>. Importances derived by dropping each column and retraining <tt>scikit-learn</tt> Random Forest <b>regressor</b>. Predicting apartment rental price from 4 features + a column of random numbers. The importance of the random column is at the bottom as it should be.
</tr>
</table>

<table border=0>
<tr>
	<td width="50%"><img src="images/cls_permute_random.svg" width="85%"><br>
<b>Figure 3(a)</b>. Importances derived by permuting each column and computing drop in out-of-bag accuracy using <tt>scikit-learn</tt> Random Forest <b>classifier</b>.
	<td width="50%"><img src="images/regr_permute_random.svg" width="85%"><br>
<b>Figure 3(b)</b>. Importances derived by permuting each column and computing drop in out-of-bag R^2 using <tt>scikit-learn</tt> <b>regressor</b>. Predicting apartment rental price from 4 features + a column of random numbers.
</tr>
</table>
<div class="codeblk">import pandas as pd
df = pd.read_csv("data/rent.csv")
df.head(3) # dump first 3 rows
</div>

<div class="codeblk">from sklearn.ensemble import RandomForestClassifier

X_train, y_train = df.drop('interest_level',axis=1), df['interest_level']
rf = RandomForestClassifier(n_estimators=100,
                            min_samples_leaf=5,
                            n_jobs=-1,
                            oob_score=True)
rf.fit(X_train, y_train)
print(f"RF OOB accuracy {rf.oob_score_:.4f}")
</div>

<div class="codeblk">import matplotlib.pyplot as plt

def plot_importances(columns,importances,figsize=None):
    I = pd.DataFrame(data={'Feature':columns, 'Importance':importances})
    I = I.set_index('Feature')
    I = I.sort_values('Importance', ascending=True)
    I.plot(kind='barh', figsize=figsize, legend=False, fontsize=16)
    plt.tight_layout()
    plt.show()
	
plot_importances(X_train.columns,rf.feature_importances_)
</div>

<span class="sidenote">
<img src="images/cls_dflt.svg" width="100%">
<b>Figure 1(a)</b>. RF classifier predicting apartment interest level (low, medium, high) using 5 features. Nothing suspicious.
</span>

<span class="sidenote">
<img src="images/cls_dflt_random_annotated.png" width="100%">
<b>Figure 1(b)</b>. RF classifier predicting apartment interest level (low, medium, high) using 5 features + a column of random numbers. Highly suspicious that random column is much more important than the number of bedrooms.
</span>

<div class="codeblk">import numpy as np
from sklearn.base import clone

X_train2 = X_train.copy()
X_train2['random'] = np.random.random(size=len(X_train2))
rf2 = clone(rf)
rf2.fit(X_train2, y_train)
plot_importances(X_train2.columns,rf2.feature_importances_)
</div>

<div class="codeblk">dfcls = df.copy()
dfcls['price'] = np.log(dfcls['price'])
X_train, y_train = dfcls.drop(['price','interest_level'],axis=1), dfcls['price']
dfcls.head(2)
</div>

<div class="codeblk">from sklearn.ensemble import RandomForestRegressor

rfcls = RandomForestRegressor(n_estimators=100,
	                          min_samples_leaf=1,
	                          n_jobs=-1,
	                          oob_score=True)
rfcls.fit(X_train, y_train)
plot_importances(X_train.columns, rfcls.feature_importances_)
</div>

<div class="codeblk">X_train2 = X_train.copy()
X_train2['random'] = np.random.random(size=len(X_train2))
rfcls2 = clone(rfcls)
rfcls2.fit(X_train2, y_train)
plot_importances(X_train2.columns,rfcls2.feature_importances_)
</div>

<span class="sidenote">
<img src="images/regr_dflt_annotated.png" width="100%">
<b>Figure 2(a)</b>. RF regressor predicting apartment rental price from 4 features. Highly suspicious that the number of bathrooms is the most important predictor of price.
</span>

<span class="sidenote">
<img src="images/regr_dflt_random_annotated.png" width="100%">
<b>Figure 2(b)</b>. RF regressor predicting apartment rental price from 4 features + a column of random numbers. Random column is last, as we would expect but the importance of the number of bathrooms is still suspicious.
</span>




</body>
</html>