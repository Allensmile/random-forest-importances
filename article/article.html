<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" type="text/css" href="http://fonts.googleapis.com/css?family=Merriweather:300,700,700italic,300italic|Open+Sans:700,400" />
<link rel="stylesheet" type="text/css" href="css/book.css"/>
<title>Default Random Forest Importances Are Inaccurate</title>
</head>
<body>
<h1>Default Random Forest Importances Are Inaccurate</h1>

<a href="http://parrt.cs.usfca.edu">Terence Parr</a>, Chris, Kerem, and <a href="http://www.fast.ai/about/#jeremy">Jeremy Howard</a>.

<div class="codeblk">import pandas as pd
df = pd.read_csv("data/rent.csv")
df.head(3) # dump first 3 rows
</div>

<div class="codeblk">from sklearn.ensemble import RandomForestClassifier

X_train, y_train = df.drop('interest_level',axis=1), df['interest_level']
rf = RandomForestClassifier(n_estimators=100,
                            min_samples_leaf=5,
                            n_jobs=-1,
                            oob_score=True)
rf.fit(X_train, y_train)
print(f"RF OOB accuracy {rf.oob_score_:.4f}")
</div>

<div class="codeblk">import matplotlib.pyplot as plt

def plot_importances(columns,importances,figsize=None):
    I = pd.DataFrame(data={'Feature':columns, 'Importance':importances})
    I = I.set_index('Feature')
    I = I.sort_values('Importance', ascending=True)
    I.plot(kind='barh', figsize=figsize, legend=False, fontsize=16)
    plt.tight_layout()
    plt.show()
	
plot_importances(X_train.columns,rf.feature_importances_)
</div>

<span class="sidenote">
<img src="images/cls_dflt.svg" width="100%">
<b>Figure 1(a)</b>. foo
</span>

<span class="sidenote">
<img src="images/cls_dflt_random_annotated.png" width="100%">
<b>Figure 1(b)</b>. foo
</span>

<div class="codeblk">import numpy as np
from sklearn.base import clone

X_train2 = X_train.copy()
X_train2['random'] = np.random.random(size=len(X_train2))
rf2 = clone(rf)
rf2.fit(X_train2, y_train)
plot_importances(X_train2.columns,rf2.feature_importances_)
</div>

<div class="codeblk">dfcls = df.copy()
dfcls['price'] = np.log(dfcls['price'])
X_train, y_train = dfcls.drop(['price','interest_level'],axis=1), dfcls['price']
dfcls.head(2)
</div>

<div class="codeblk">from sklearn.ensemble import RandomForestRegressor

rfcls = RandomForestRegressor(n_estimators=100,
	                          min_samples_leaf=1,
	                          n_jobs=-1,
	                          oob_score=True)
rfcls.fit(X_train, y_train)
plot_importances(X_train.columns, rfcls.feature_importances_)
</div>

<div class="codeblk">X_train2 = X_train.copy()
X_train2['random'] = np.random.random(size=len(X_train2))
rfcls2 = clone(rfcls)
rfcls2.fit(X_train2, y_train)
plot_importances(X_train2.columns,rfcls2.feature_importances_)
</div>

<span class="sidenote">
<img src="images/regr_dflt_annotated.png" width="100%">
<b>Figure 2(a)</b>. foo
</span>

<span class="sidenote">
<img src="images/regr_dflt_random_annotated.png" width="100%">
<b>Figure 2(b)</b>. foo
</span>

</body>
</html>